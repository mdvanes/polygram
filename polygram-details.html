<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="polygram-element-styles.html">

<dom-module id="polygram-details">
    <template>
        <style include="polygram-element-styles"></style>
        <style>
            :root {
                --btn-toggle-color: #3335FF;
                --btn-toggle-border-color: #3C70FF;
            }
        </style>
        <div>
            <h2>Details for [[term]]:</h2>

            <template is="dom-if" if="{{!_searchResult}}">
                Loading...
            </template>

            <template is="dom-if" if="{{_searchResult}}">
                <h3><a href="https://en.wikipedia.org/wiki/[[_searchResult.title]]">[[_searchResult.title]]</a> ([[_searchResult.size]])</h3>
                <div>[[_searchResult.summary]]</div>
            </template>

            <iron-request id="xhr"></iron-request>
            <!--
             Without auto, call manually with:
              this.$.searchIARequest.generateRequest() in e.g. ready()
            -->
            <iron-ajax
                    auto
                    id="searchIARequest"
                    url="{{_searchIAUrl}}"
                    handle-as="json"
                    debounce-duration="500"
                    on-response="_searchIAHandler"></iron-ajax>
        </div>

    </template>

    <script>
        /**
         * `polygram-details`
         * load photos in instagram style
         *
         * @customElement
         * @polymer
         * @demo demo/polygram-details/index.html
         */
        class PolygramDetails extends Polymer.Element {
            static get is() {
                return 'polygram-details';
            }

            static get properties() {
                return {
                    term: {
                        type: String,
                        value: null,
                        observer: '_termChanged'
                    },
                    _searchIAUrl: {
                        type: String,
                        value: null
                    },
                    _searchResult: {
                        type: Object,
                        value: null
                    },
                    state: {
                        type: Object,
                        observer: '_stateChanged'
                    }
                };
            }

            _stateChanged(state) {
                console.log('new state', state);
                this.term = state.term.selectedTerm;
            }

            _termChanged(term) {
                this._searchResult = null;
                if(term && term.length > 0) {
                    this._searchIAUrl = `https://cors-anywhere.herokuapp.com/en.wikipedia.org:443/w/api.php?action=query&format=json&list=search&srsearch=${encodeURI(term)}`;
                }
            }

            _searchIAHandler(data) {
                console.log(data, data.detail, data.detail.response);
                if(data && data.detail && data.detail.response &&
                    data.detail.response.query && data.detail.response.query.search) {
                    this._searchResult = {
                        title: data.detail.response.query.search[0].title,
                        size: data.detail.response.query.search[0].size,
                        summary: data.detail.response.query.search[0].snippet
                    }
                }
            }

            ready() {
                super.ready();
                console.log(this.term, this.state);
            }
        }

        window.customElements.define(PolygramDetails.is, PolygramDetails);
    </script>
</dom-module>
